tests
testAmb
	"(⊦= '(1 2 3) (reify (amb 1 2 3)))
                    (⊦= '(8 9 9 10) (reify (+ (amb 1 2) 3 (amb 4 5))))
                    (⊦= '(31 51) (reify (+ 1 (letcc k (* 10 (amb 3 (k 4)))))))

(define (www)
                     (define (f x) (+ x (amb 6 4 2 8) (amb 2 4 5 4 1)))
                     (reify (f (f (amb 0 2 3 4 5 32)))))"

	| res |
	res := self amb: #( 1 2 3 ) in: [ :p | p ].

	self assert: res equals: #( 1 2 3 ).

	res := self
		       amb: #( 1 2 )
		       in: [ :v | self amb: #( 4 5 ) in: [ :w | v + 3 + w ] ].

	self assert: res equals: #( 8 9 9 10 ).

	res := self
		       amb: #( 0 2 3 4 5 32 )
		       in: [ :p |
		       self wwwF: p in: [ :v | self wwwF: v in: [ :u | u ] ] ].

	self
		assert: res
		equals:
			#( 16 18 19 18 15 14 16 17 16 13 12 14 15 14 11 18 20 21 20 17 18
			   20 21 20 17 16 18 19 18 15 14 16 17 16 13 20 22 23 22 19 19 21
			   22 21 18 17 19 20 19 16 15 17 18 17 14 21 23 24 23 20 18 20 21
			   20 17 16 18 19 18 15 14 16 17 16 13 20 22 23 22 19 15 17 18 17
			   14 13 15 16 15 12 11 13 14 13 10 17 19 20 19 16 14 16 17 16 13
			   12 14 15 14 11 10 12 13 12 9 16 18 19 18 15 16 18 19 18 15 14 16
			   17 16 13 12 14 15 14 11 18 20 21 20 17 17 19 20 19 16 15 17 18
			   17 14 13 15 16 15 12 19 21 22 21 18 16 18 19 18 15 14 16 17 16
			   13 12 14 15 14 11 18 20 21 20 17 13 15 16 15 12 11 13 14 13 10
			   9 11 12 11 8 15 17 18 17 14 12 14 15 14 11 10 12 13 12 9 8 10 11
			   10 7 14 16 17 16 13 14 16 17 16 13 12 14 15 14 11 10 12 13 12 9
			   16 18 19 18 15 15 17 18 17 14 13 15 16 15 12 11 13 14 13 10 17
			   19 20 19 16 14 16 17 16 13 12 14 15 14 11 10 12 13 12 9 16 18 19
			   18 15 11 13 14 13 10 9 11 12 11 8 7 9 10 9 6 13 15 16 15 12 18
			   20 21 20 17 16 18 19 18 15 14 16 17 16 13 20 22 23 22 19 20 22
			   23 22 19 18 20 21 20 17 16 18 19 18 15 22 24 25 24 21 21 23 24
			   23 20 19 21 22 21 18 17 19 20 19 16 23 25 26 25 22 20 22 23 22
			   19 18 20 21 20 17 16 18 19 18 15 22 24 25 24 21 17 19 20 19 16
			   15 17 18 17 14 13 15 16 15 12 19 21 22 21 18 18 20 21 20 17 16
			   18 19 18 15 14 16 17 16 13 20 22 23 22 19 20 22 23 22 19 18 20
			   21 20 17 16 18 19 18 15 22 24 25 24 21 21 23 24 23 20 19 21 22
			   21 18 17 19 20 19 16 23 25 26 25 22 20 22 23 22 19 18 20 21 20
			   17 16 18 19 18 15 22 24 25 24 21 17 19 20 19 16 15 17 18 17 14
			   13 15 16 15 12 19 21 22 21 18 16 18 19 18 15 14 16 17 16 13 12
			   14 15 14 11 18 20 21 20 17 18 20 21 20 17 16 18 19 18 15 14 16
			   17 16 13 20 22 23 22 19 19 21 22 21 18 17 19 20 19 16 15 17 18
			   17 14 21 23 24 23 20 18 20 21 20 17 16 18 19 18 15 14 16 17 16
			   13 20 22 23 22 19 15 17 18 17 14 13 15 16 15 12 11 13 14 13 10
			   17 19 20 19 16 14 16 17 16 13 12 14 15 14 11 10 12 13 12 9 16 18
			   19 18 15 16 18 19 18 15 14 16 17 16 13 12 14 15 14 11 18 20 21
			   20 17 17 19 20 19 16 15 17 18 17 14 13 15 16 15 12 19 21 22 21
			   18 16 18 19 18 15 14 16 17 16 13 12 14 15 14 11 18 20 21 20 17
			   13 15 16 15 12 11 13 14 13 10 9 11 12 11 8 15 17 18 17 14 20 22
			   23 22 19 18 20 21 20 17 16 18 19 18 15 22 24 25 24 21 22 24 25
			   24 21 20 22 23 22 19 18 20 21 20 17 24 26 27 26 23 23 25 26 25
			   22 21 23 24 23 20 19 21 22 21 18 25 27 28 27 24 22 24 25 24 21
			   20 22 23 22 19 18 20 21 20 17 24 26 27 26 23 19 21 22 21 18 17
			   19 20 19 16 15 17 18 17 14 21 23 24 23 20 19 21 22 21 18 17 19
			   20 19 16 15 17 18 17 14 21 23 24 23 20 21 23 24 23 20 19 21 22
			   21 18 17 19 20 19 16 23 25 26 25 22 22 24 25 24 21 20 22 23 22
			   19 18 20 21 20 17 24 26 27 26 23 21 23 24 23 20 19 21 22 21 18
			   17 19 20 19 16 23 25 26 25 22 18 20 21 20 17 16 18 19 18 15 14
			   16 17 16 13 20 22 23 22 19 17 19 20 19 16 15 17 18 17 14 13 15
			   16 15 12 19 21 22 21 18 19 21 22 21 18 17 19 20 19 16 15 17 18
			   17 14 21 23 24 23 20 20 22 23 22 19 18 20 21 20 17 16 18 19 18
			   15 22 24 25 24 21 19 21 22 21 18 17 19 20 19 16 15 17 18 17 14
			   21 23 24 23 20 16 18 19 18 15 14 16 17 16 13 12 14 15 14 11 18
			   20 21 20 17 15 17 18 17 14 13 15 16 15 12 11 13 14 13 10 17 19
			   20 19 16 17 19 20 19 16 15 17 18 17 14 13 15 16 15 12 19 21 22
			   21 18 18 20 21 20 17 16 18 19 18 15 14 16 17 16 13 20 22 23 22
			   19 17 19 20 19 16 15 17 18 17 14 13 15 16 15 12 19 21 22 21 18
			   14 16 17 16 13 12 14 15 14 11 10 12 13 12 9 16 18 19 18 15 21 23
			   24 23 20 19 21 22 21 18 17 19 20 19 16 23 25 26 25 22 23 25 26
			   25 22 21 23 24 23 20 19 21 22 21 18 25 27 28 27 24 24 26 27 26
			   23 22 24 25 24 21 20 22 23 22 19 26 28 29 28 25 23 25 26 25 22
			   21 23 24 23 20 19 21 22 21 18 25 27 28 27 24 20 22 23 22 19 18
			   20 21 20 17 16 18 19 18 15 22 24 25 24 21 20 22 23 22 19 18 20
			   21 20 17 16 18 19 18 15 22 24 25 24 21 22 24 25 24 21 20 22 23
			   22 19 18 20 21 20 17 24 26 27 26 23 23 25 26 25 22 21 23 24 23
			   20 19 21 22 21 18 25 27 28 27 24 22 24 25 24 21 20 22 23 22 19
			   18 20 21 20 17 24 26 27 26 23 19 21 22 21 18 17 19 20 19 16 15
			   17 18 17 14 21 23 24 23 20 18 20 21 20 17 16 18 19 18 15 14 16
			   17 16 13 20 22 23 22 19 20 22 23 22 19 18 20 21 20 17 16 18 19
			   18 15 22 24 25 24 21 21 23 24 23 20 19 21 22 21 18 17 19 20 19
			   16 23 25 26 25 22 20 22 23 22 19 18 20 21 20 17 16 18 19 18 15
			   22 24 25 24 21 17 19 20 19 16 15 17 18 17 14 13 15 16 15 12 19
			   21 22 21 18 16 18 19 18 15 14 16 17 16 13 12 14 15 14 11 18 20
			   21 20 17 18 20 21 20 17 16 18 19 18 15 14 16 17 16 13 20 22 23
			   22 19 19 21 22 21 18 17 19 20 19 16 15 17 18 17 14 21 23 24 23
			   20 18 20 21 20 17 16 18 19 18 15 14 16 17 16 13 20 22 23 22 19
			   15 17 18 17 14 13 15 16 15 12 11 13 14 13 10 17 19 20 19 16 22
			   24 25 24 21 20 22 23 22 19 18 20 21 20 17 24 26 27 26 23 24 26
			   27 26 23 22 24 25 24 21 20 22 23 22 19 26 28 29 28 25 25 27 28
			   27 24 23 25 26 25 22 21 23 24 23 20 27 29 30 29 26 24 26 27 26
			   23 22 24 25 24 21 20 22 23 22 19 26 28 29 28 25 21 23 24 23 20
			   19 21 22 21 18 17 19 20 19 16 23 25 26 25 22 21 23 24 23 20 19
			   21 22 21 18 17 19 20 19 16 23 25 26 25 22 23 25 26 25 22 21 23
			   24 23 20 19 21 22 21 18 25 27 28 27 24 24 26 27 26 23 22 24 25
			   24 21 20 22 23 22 19 26 28 29 28 25 23 25 26 25 22 21 23 24 23
			   20 19 21 22 21 18 25 27 28 27 24 20 22 23 22 19 18 20 21 20 17
			   16 18 19 18 15 22 24 25 24 21 19 21 22 21 18 17 19 20 19 16 15
			   17 18 17 14 21 23 24 23 20 21 23 24 23 20 19 21 22 21 18 17 19
			   20 19 16 23 25 26 25 22 22 24 25 24 21 20 22 23 22 19 18 20 21
			   20 17 24 26 27 26 23 21 23 24 23 20 19 21 22 21 18 17 19 20 19
			   16 23 25 26 25 22 18 20 21 20 17 16 18 19 18 15 14 16 17 16 13
			   20 22 23 22 19 17 19 20 19 16 15 17 18 17 14 13 15 16 15 12 19
			   21 22 21 18 19 21 22 21 18 17 19 20 19 16 15 17 18 17 14 21 23
			   24 23 20 20 22 23 22 19 18 20 21 20 17 16 18 19 18 15 22 24 25
			   24 21 19 21 22 21 18 17 19 20 19 16 15 17 18 17 14 21 23 24 23
			   20 16 18 19 18 15 14 16 17 16 13 12 14 15 14 11 18 20 21 20 17
			   23 25 26 25 22 21 23 24 23 20 19 21 22 21 18 25 27 28 27 24 25
			   27 28 27 24 23 25 26 25 22 21 23 24 23 20 27 29 30 29 26 26 28
			   29 28 25 24 26 27 26 23 22 24 25 24 21 28 30 31 30 27 25 27 28
			   27 24 23 25 26 25 22 21 23 24 23 20 27 29 30 29 26 22 24 25 24
			   21 20 22 23 22 19 18 20 21 20 17 24 26 27 26 23 48 50 51 50 47
			   46 48 49 48 45 44 46 47 46 43 50 52 53 52 49 50 52 53 52 49 48
			   50 51 50 47 46 48 49 48 45 52 54 55 54 51 51 53 54 53 50 49 51
			   52 51 48 47 49 50 49 46 53 55 56 55 52 50 52 53 52 49 48 50 51
			   50 47 46 48 49 48 45 52 54 55 54 51 47 49 50 49 46 45 47 48 47
			   44 43 45 46 45 42 49 51 52 51 48 46 48 49 48 45 44 46 47 46 43
			   42 44 45 44 41 48 50 51 50 47 48 50 51 50 47 46 48 49 48 45 44
			   46 47 46 43 50 52 53 52 49 49 51 52 51 48 47 49 50 49 46 45 47
			   48 47 44 51 53 54 53 50 48 50 51 50 47 46 48 49 48 45 44 46 47
			   46 43 50 52 53 52 49 45 47 48 47 44 43 45 46 45 42 41 43 44 43
			   40 47 49 50 49 46 44 46 47 46 43 42 44 45 44 41 40 42 43 42 39
			   46 48 49 48 45 46 48 49 48 45 44 46 47 46 43 42 44 45 44 41 48
			   50 51 50 47 47 49 50 49 46 45 47 48 47 44 43 45 46 45 42 49 51
			   52 51 48 46 48 49 48 45 44 46 47 46 43 42 44 45 44 41 48 50 51
			   50 47 43 45 46 45 42 41 43 44 43 40 39 41 42 41 38 45 47 48 47
			   44 50 52 53 52 49 48 50 51 50 47 46 48 49 48 45 52 54 55 54 51
			   52 54 55 54 51 50 52 53 52 49 48 50 51 50 47 54 56 57 56 53 53
			   55 56 55 52 51 53 54 53 50 49 51 52 51 48 55 57 58 57 54 52 54
			   55 54 51 50 52 53 52 49 48 50 51 50 47 54 56 57 56 53 49 51 52
			   51 48 47 49 50 49 46 45 47 48 47 44 51 53 54 53 50 ).

	res := self amb: #( 0 2 3 4 5 32 ) in: [ :p |
		       self
			       wwwF: p
			       in: [ :v |
			       self wwwF: v in: [ :u | self wwwF: u in: [ :r | r ] ] ] ].

	self assert: res size equals: 48000